<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture - L'Échoppe Gauloise</title>
    
    <!-- Polices -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<style>
    :root {
        --primary: #f69e0b;
        --primary-dark: #d97706;
        --text: #0f172a;
        --text-light: #64748b;
        --bg: #ffffff;
        --bg-subtle: #f8fafc;
        --border: #e2e8f0;
        --success: #10b981;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-subtle);
        color: var(--text);
        line-height: 1.5;
        padding: 1.5rem 1rem;
    }

    .container {
        max-width: 850px;
        margin: 0 auto;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    /* Accent bar - drapeau français */
    .accent-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #002395 0%, #002395 33.33%, white 33.33%, white 66.66%, #ED2939 66.66%, #ED2939 100%);
    }

    /* Header */
    .header {
        padding: 1.75rem 2rem 1.25rem;
        border-bottom: 1px solid var(--border);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .logo-section {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .logo-section img {
        height: 40px;
        width: auto;
    }

    .company-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
    }

    .invoice-meta {
        text-align: right;
    }

    .invoice-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-light);
        margin-bottom: 0.35rem;
    }

    .invoice-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
        font-variant-numeric: tabular-nums;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        background: #ecfdf5;
        color: var(--success);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .header-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .info-block h3 {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }

    .info-block p {
        font-size: 0.8rem;
        color: var(--text);
        line-height: 1.6;
    }

    .info-block p strong {
        font-weight: 600;
    }

    /* Actions */
    .actions {
        padding: 0 2rem 1.25rem;
        display: flex;
        gap: 0.75rem;
    }

    .btn {
        flex: 1;
        padding: 0.65rem 1.25rem;
        border: 1px solid var(--border);
        border-radius: 5px;
        background: white;
        color: var(--text);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        transition: all 0.15s ease;
        text-decoration: none;
        font-family: inherit;
    }

    .btn:hover {
        background: var(--bg-subtle);
        border-color: var(--text-light);
    }

    .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    /* Body */
    .body {
        padding: 1.5rem 2rem;
    }

    .items-section {
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-light);
        margin-bottom: 0.75rem;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
    }

    .items-table thead th {
        text-align: left;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-light);
    }

    .items-table thead th:last-child {
        text-align: right;
    }

    .items-table tbody td {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.8rem;
    }

    .items-table tbody tr:last-child td {
        border-bottom: none;
    }

    .items-table tbody td:last-child {
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-weight: 500;
    }

    .item-name {
        font-weight: 500;
        color: var(--text);
    }

    .item-description {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.15rem;
    }

    /* Summary */
    .summary-section {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1.5rem;
    }

    .summary-box {
        width: 100%;
        max-width: 300px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.8rem;
    }

    .summary-row:not(:last-child) {
        border-bottom: 1px solid var(--border);
    }

    .summary-label {
        color: var(--text-light);
    }

    .summary-value {
        font-variant-numeric: tabular-nums;
        font-weight: 500;
        color: var(--text);
    }

    .summary-row.total {
        padding-top: 0.75rem;
        margin-top: 0.35rem;
        border-top: 2px solid var(--text);
        font-size: 1rem;
        font-weight: 600;
    }

    .summary-row.total .summary-value {
        color: var(--primary);
        font-weight: 700;
    }

    /* Payment Info */
    .payment-section {
        background: var(--bg-subtle);
        padding: 1.25rem;
        border-radius: 6px;
        margin-bottom: .5rem;
    }

    .payment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .payment-item {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .payment-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-light);
    }

    .payment-value {
        font-size: 0.8rem;
        color: var(--text);
        font-weight: 500;
    }

    /* Footer */
    .footer {
        padding: 1.25rem 2rem 1.5rem;
        border-top: 1px solid var(--border);
    }

    .legal {
        font-size: 0.7rem;
        color: var(--text-light);
        line-height: 1.7;
        margin-bottom: 0.75rem;
    }

    .footer-note {
        text-align: center;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .footer-note p {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-light);
        margin: 0;
    }

    /* MOBILE STYLE */
    @media (max-width: 768px) {
        body { padding: 0; }
        .container { box-shadow: none; }
        .header, .body, .footer, .actions { padding-left: 1.25rem; padding-right: 1.25rem; }
        .header-top { flex-direction: column; gap: 1.25rem; }
        .invoice-meta { text-align: left; }
        .header-grid { grid-template-columns: 1fr; gap: 1.25rem; }
        .summary-box { max-width: 100%; }
        .payment-grid { grid-template-columns: 1fr; }
        .actions { flex-direction: column; }
    }

    /* PRINT STYLE - Optimisé pour 1 page ou plus selon contenu */
    @media print {
        @page {
            size: A4;
            margin: 10mm 15mm; /* Marges réduites pour gagner de la place */
        }

        body { 
            background: white; 
            padding: 0; 
            font-size: 11pt; /* Taille de police standard pour impression */
        }

        .container { 
            box-shadow: none; 
            max-width: 100% !important; 
            width: 100%; 
        }

        .actions { display: none !important; }
        .accent-bar { print-color-adjust: exact; -webkit-print-color-adjust: exact; }

        /* Optimisation d'espace */
        .header { padding: 0.5rem 0 1rem; }
        .body { padding: 1rem 0; }
        .footer { padding: 0.5rem 0; page-break-inside: avoid; }
        
        .header-top { 
            display: flex !important; 
            flex-direction: row !important; 
            justify-content: space-between !important; 
            margin-bottom: 1rem;
        }

        .header-grid { 
            display: grid !important; 
            grid-template-columns: 1fr 1fr !important; 
            gap: 2rem !important; 
        }

        .invoice-meta { text-align: right !important; }

        /* Gestion dynamique du tableau */
        .items-section { margin-bottom: 1rem; }
        .items-table tbody td { padding: 0.35rem 0; }
        
        /* Permettre la coupure du tableau entre les pages si nécessaire */
        .items-table tr { page-break-inside: avoid; page-break-after: auto; }
        
        .summary-section { 
            display: flex !important; 
            justify-content: flex-end !important; 
            margin-bottom: 1rem;
            page-break-inside: avoid; 
        }
        
        .summary-box { max-width: 250px !important; margin-left: auto; }

        .payment-section { 
            margin-bottom: 1rem; 
            padding: 0.75rem;
            page-break-inside: avoid; 
        }

        .payment-grid { 
            display: grid !important; 
            grid-template-columns: repeat(3, 1fr) !important; 
        }

        .footer-note i { color: #333 !important; }

        /* Si le contenu est court, on essaie de tout garder sur une page */
        /* Si le tableau est trop long (>10 lignes env.), il coulera naturellement sur la page 2 */
    }
</style>
</head>
<body>
    <div class="container">
        <div class="accent-bar"></div>
        
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="logo-section">
                    <img src="../..../../../../assets/logo.svg" alt="L'Échoppe Gauloise" id="companyLogo" onerror="this.style.display='none'">
                    <span class="company-name">L'Échoppe Gauloise</span>
                </div>
                
                <div class="invoice-meta">
                    <div class="invoice-title">Facture</div>
                    <div class="invoice-number" id="invoiceNumber">ECHO-000000</div>
                    <div class="status-badge">
                        <i class="fas fa-check-circle"></i>
                        <span>Payé</span>
                    </div>
                </div>
            </div>

            <div class="header-grid">
                <div class="info-block">
                    <h3>Émetteur</h3>
                    <div class="info-content">
                        <p class="company-name"><strong>L'Échoppe Gauloise SAS</strong></p>
                        <p><i data-lucide="map-pin" stroke-width="2" width="14" height="14"></i> 123 Rue de la République</p>
                        <p><i data-lucide="earth" stroke-width="2" width="14" height="14"></i> 75001 Paris, France</p>
                        <p><i data-lucide="mail" stroke-width="2" width="14" height="14"></i> contact@echoppe-gauloise.fr</p>
                        <p><i data-lucide="phone" stroke-width="2" width="14" height="14"></i> +33 1 23 45 67 89</p><br>

                        <div class="tax-info">
                            <p>SIRET: 123 456 789 00012</p>
                            <p>TVA: FR12345678900</p>
                        </div>
                    </div>
                </div>

                <div class="info-block">
                    <h3>Destinataire</h3>
                    <div class="info-content">
                        <p class="company-name"><strong id="customerName">-</strong></p>
                        <p><i data-lucide="map-pin" stroke-width="2" width="14" height="14"></i> <span id="customerAddress">-</span></p>
                        <p><i data-lucide="earth" stroke-width="2" width="14" height="14"></i> <span id="customerCityCountry">-</span> <span id="customerCountry">-</span></p>
                        <p><i data-lucide="mail" stroke-width="2" width="14" height="14"></i> <span id="customerEmail">-</span></p>
                        <p><i data-lucide="phone" stroke-width="2" width="14" height="14"></i> <span id="customerPhone">-</span></p>
                    </div>
                </div>
            </div>

        <!-- Actions -->
        <div class="actions">
            <button class="btn" onclick="window.print()">
                <i class="fas fa-print"></i>
                Imprimer
            </button>
            <button class="btn" onclick="downloadPDF()">
                <i class="fas fa-download"></i>
                Télécharger
            </button>
            <a href="../../../../index.html" class="btn btn-primary">
                <i class="fas fa-home"></i>
                Accueil
            </a>
        </div>

        <!-- Body -->
        <div class="body">
            <!-- Items -->
            <div class="items-section">
                <h2 class="section-title">Articles</h2>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="width: 60px;">Qté</th>
                            <th style="width: 90px; text-align: right;">Prix HT</th>
                            <th style="width: 50px; text-align: right;">TVA</th>
                            <th style="width: 100px; text-align: right;">Total HT</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Items dynamiques -->
                    </tbody>
                </table>
            </div>

            <!-- Summary -->
            <div class="summary-section">
                <div class="summary-box">
                    <div class="tva-breakdown" id="tvaBreakdown">
                        <!-- Détails TVA par taux -->
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Sous-total HT</span>
                        <span class="summary-value" id="subtotalHT">0,00 €</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total TVA</span>
                        <span class="summary-value" id="totalTVA">0,00 €</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Livraison TTC</span>
                        <span class="summary-value" id="shippingCost">0,00 €</span>
                    </div>
                    <div class="summary-row total">
                        <span class="summary-label">Total TTC</span>
                        <span class="summary-value" id="totalAmount">0,00 €</span>
                    </div>
                </div>
            </div>

            <!-- Payment Info -->
            <div class="payment-section">
                <div class="payment-grid">
                    <div class="payment-item">
                        <span class="payment-label">Date facture</span>
                        <span class="payment-value" id="invoiceDate">-</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label">Paiement</span>
                        <span class="payment-value" id="paymentMethod">-</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label">Date paiement</span>
                        <span class="payment-value" id="paymentDate">-</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label">Livraison estimée</span>
                        <span class="payment-value" id="estimatedDelivery">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="legal">
                <p>
                    <strong>Conditions:</strong> Paiement comptant. Pénalités: BCE + 10 pts. Indemnité recouvrement: 40 €.
                </p>

            </div>
            
            <div class="footer-note">
                <p><i data-lucide="building" stroke-width="2" width="16" height="16"></i> Siège: 123 Rue de la République, 75001 Paris</p>
                <p><i data-lucide="briefcase" stroke-width="2" width="14" height="14"></i> Capital: 50 000 € - APE: 4725Z</p>
                <p><i data-lucide="mail" stroke-width="2" width="14" height="14"></i> facturation@echoppe-gauloise.fr</p>
                <p><i data-lucide="phone" stroke-width="2" width="14" height="14"></i> +33 1 23 45 67 89</p>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
    lucide.createIcons();
    </script>
    <script>
        // TVA rates configurables
        const TVA_RATES = {
            'standard': 0.20,    // 20% - Taux normal
            'intermediate': 0.10, // 10% - Taux intermédiaire
            'reduced': 0.055,    // 5.5% - Taux réduit
            'special': 0.021     // 2.1% - Taux particulier
        };

        function formatPrice(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function calculateTVA(amountHT, rate = 0.20) {
            return amountHT * rate;
        }

        function calculateHT(amountTTC, rate = 0.20) {
            return amountTTC / (1 + rate);
        }

        function getTVARate(item) {
            // Si l'article a un taux de TVA spécifique, l'utiliser
            if (item.tvaRate !== undefined) {
                return item.tvaRate;
            }
            // Sinon, utiliser le taux standard (20%)
            return TVA_RATES.standard;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const orderData = JSON.parse(localStorage.getItem('lastOrder') || '{}');
            
            if (!orderData.orderNumber) {
                console.warn('Aucune commande trouvée');
                return;
            }

            // Header
            document.getElementById('invoiceNumber').textContent = orderData.orderNumber;
            document.getElementById('invoiceDate').textContent = orderData.orderDate || new Date().toLocaleDateString('fr-FR');

            // Client
            if (orderData.shipping) {
                document.getElementById('customerName').textContent = 
                    `${orderData.shipping.firstName || ''} ${orderData.shipping.lastName || ''}`.trim();
                document.getElementById('customerAddress').textContent = orderData.shipping.address || '-';
                document.getElementById('customerCityCountry').textContent = 
                    `${orderData.shipping.postalCode || ''} ${orderData.shipping.city || ''}`.trim();
                document.getElementById('customerCountry').textContent = orderData.shipping.country || '-';
                document.getElementById('customerEmail').textContent = orderData.shipping.email || '-';
                document.getElementById('customerPhone').textContent = orderData.shipping.phone || '-';
            }

            // Payment
            const paymentMethods = {
                'card': 'Carte bancaire',
                'paypal': 'PayPal',
                'bank_transfer': 'Virement'
            };
            document.getElementById('paymentMethod').textContent = 
                paymentMethods[orderData.payment?.method] || 'Carte';
            document.getElementById('paymentDate').textContent = orderData.orderDate || '-';
            document.getElementById('estimatedDelivery').textContent = orderData.estimatedDelivery || '-';

            // Items avec gestion multi-TVA
            const tbody = document.getElementById('itemsTableBody');
            let subtotalHT = 0;
            const tvaByRate = {}; // Pour regrouper la TVA par taux

            if (orderData.cart && orderData.cart.length > 0) {
                orderData.cart.forEach(item => {
                    const tvaRate = getTVARate(item);
                    const priceTTC = item.price || 0;
                    const priceHT = calculateHT(priceTTC, tvaRate);
                    const quantity = item.quantity || 1;
                    const totalHT = priceHT * quantity;
                    const tvaAmount = calculateTVA(priceHT, tvaRate) * quantity;
                    
                    subtotalHT += totalHT;

                    // Regrouper la TVA par taux
                    const ratePercent = (tvaRate * 100).toFixed(1);
                    if (!tvaByRate[ratePercent]) {
                        tvaByRate[ratePercent] = 0;
                    }
                    tvaByRate[ratePercent] += tvaAmount;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="item-name">${item.name || 'Article'}</div>
                            ${item.description ? `<div class="item-description">${item.description}</div>` : ''}
                        </td>
                        <td>${quantity}</td>
                        <td style="text-align: right;">${formatPrice(priceHT)}</td>
                        <td style="text-align: right;">${ratePercent}%</td>
                        <td>${formatPrice(totalHT)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light);">Aucun article</td></tr>';
            }

            // Afficher le détail de la TVA par taux
            const tvaBreakdown = document.getElementById('tvaBreakdown');
            let totalTVA = 0;
            
            Object.keys(tvaByRate).sort((a, b) => parseFloat(b) - parseFloat(a)).forEach(rate => {
                const amount = tvaByRate[rate];
                totalTVA += amount;
                
                const breakdownRow = document.createElement('div');
                breakdownRow.className = 'tva-breakdown-row';
                breakdownRow.innerHTML = `
                    <span>TVA ${rate}%</span>
                    <span>${formatPrice(amount)}</span>
                `;
                tvaBreakdown.appendChild(breakdownRow);
            });

            // Totals
            const shippingTTC = orderData.totals?.shipping || 0;
            const shippingHT = calculateHT(shippingTTC, TVA_RATES.standard);
            const shippingVAT = calculateTVA(shippingHT, TVA_RATES.standard);
            
            const grandTotalHT = subtotalHT + shippingHT;
            const grandTotalTVA = totalTVA + shippingVAT;
            const grandTotalTTC = grandTotalHT + grandTotalTVA;

            document.getElementById('subtotalHT').textContent = formatPrice(subtotalHT);
            document.getElementById('totalTVA').textContent = formatPrice(grandTotalTVA);
            document.getElementById('shippingCost').textContent = formatPrice(shippingTTC);
            document.getElementById('totalAmount').textContent = formatPrice(grandTotalTTC);
        });

        function downloadPDF() {
            alert('Fonctionnalité de téléchargement PDF à venir.\nUtilisez l\'impression en attendant.');
            window.print();
        }
    </script>
</body>
</html>